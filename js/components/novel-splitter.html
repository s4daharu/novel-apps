<!-- Novel Splitter Tool -->
<div id="novelSplitterApp" class="tool-section">
  <div id="restoreBanner" style="display:none;" class="bg-primary-600 text-white p-2 text-center">
    <p>You have an unsaved session. <button id="restoreSessionBtn" class="bg-white/20 border border-white/50 text-white ml-3 px-2 py-1 rounded">Restore Session</button> or <button id="dismissSessionBtn" class="bg-white/20 border border-white/50 text-white ml-3 px-2 py-1 rounded">Dismiss</button></p>
  </div>

  <div class="wrap">
    <!-- SETUP VIEW -->
    <div id="setupView">
      <h1 class="text-3xl font-bold text-gray-900 dark:text-white mb-2 text-center">ðŸ“– Novel Splitter</h1>
      <p class="text-slate-600 dark:text-slate-300 text-sm leading-relaxed text-center mb-4">Load a <strong>.txt</strong> novel, apply cleanup rules, add a cover, and process it into chapters. Then, edit, merge, split, and reorder chapters before exporting to <strong>ZIP</strong> or a themed <strong>EPUB</strong>.</p>

      <div class="card">
        <div class="row">
          <div id="fileDropZone" class="drop-zone" tabindex="0" role="button" aria-label="Upload novel text file">
            <label for="fileInput">Novel text file (.txt)</label>
            <input id="fileInput" type="file" accept=".txt,text/plain">
            <div id="fileNameInfo" class="small muted">Or drag and drop file here</div>
          </div>
          <div id="coverDropZone" class="drop-zone" tabindex="0" role="button" aria-label="Upload optional cover image">
            <label for="coverInput">Optional cover image</label>
            <input id="coverInput" type="file" accept="image/*">
            <div id="coverNameInfo" class="small muted">Or drag and drop image here</div>
          </div>
        </div>

        <div style="margin-top:10px">
          <label for="encodingSelect">Text Encoding <span class="tooltip-trigger" data-tooltip="Auto-detect is recommended. For garbled Chinese text, the source file may be in GBK or Big5 format. Choose the one that makes the text readable.">?</span></label>
          <select id="encodingSelect">
            <option value="auto" selected>Auto-detect (UTF-8, GBK, Big5)</option>
            <option value="utf-8">UTF-8</option>
            <option value="gbk">GBK</option>
            <option value="big5">Big5</option>
          </select>
        </div>

        <div style="margin-top:10px">
            <label>Text Cleanup Rules <span class="tooltip-trigger" data-tooltip="Enter a Regex pattern on each line. Any text that matches these patterns will be completely removed from the novel before it's split into chapters. This is useful for removing ads or repeated watermarks.">?</span></label>
            <div id="cleanupRulesContainer">
                <!-- Rules will be added here dynamically -->
            </div>
            <button id="addRuleBtn" class="small-btn">Add Rule</button>
        </div>


        <div style="margin-top:10px">
          <label for="chapterPattern">Chapter heading format <span class="tooltip-trigger" data-tooltip="Select the pattern that matches your novel's chapter headings. 'Auto Detect' is usually sufficient. If your headings aren't found, use 'Custom Regex' to define the pattern yourself.">?</span></label>
          <select id="chapterPattern">
            <option value="auto" selected>Auto Detect</option>
            <option value="chinese">Chinese: ç¬¬12ç«  â€¦</option>
            <option value="chinese_numeral">Chinese Numeral: ç¬¬ä¸€ç«  â€¦</option>
            <option value="chapter">English: Chapter 12 â€¦</option>
            <option value="ch">English: Ch. 12 â€¦</option>
            <option value="titledot">Title.Number: æ ‡é¢˜.1 (e.g. ä½œä¸ºæ–°æˆ¿å®¢çš„ç¬¬ä¸€å¤©.1)</option>
            <option value="parenfullwidth">Fullwidth paren: ï¼ˆ1.ï¼‰</option>
            <option value="custom">Custom Regex...</option>
          </select>
          <div id="customRegexContainer" style="display:none; margin-top:8px;">
              <input id="customRegexInput" type="text" placeholder="e.g. ^\\s*Chapter\\s+\\d+">
              <div class="small muted">Note: Pattern is matched against the start of a line. Use double backslashes for escapes (e.g., \\d for a digit).</div>
          </div>
          <div id="matchPreview" class="match-preview" style="display:none"></div>
        </div>
        
        <div class="meta-row" style="margin-top:12px">
            <div>
              <label class="meta-label">EPUB metadata (optional)</label>
              <input id="metaTitle" type="text" placeholder="Title (defaults to filename)">
            </div>
            <div>
              <label class="meta-label" style="visibility:hidden">author</label>
              <input id="metaAuthor" type="text" placeholder="Author (optional)">
            </div>
            <div>
                <label for="epubTheme" class="meta-label">EPUB Theme</label>
                <select id="epubTheme">
                  <option value="modern" selected>Modern</option>
                  <option value="classic">Classic</option>
                  <option value="minimal">Minimal</option>
                </select>
            </div>
        </div>

        <div class="btns">
          <button id="processBtn" class="primary" disabled>Process & Edit Chapters</button>
        </div>
        
        <div id="status" class="status small" aria-live="polite">Waiting for a .txt fileâ€¦</div>
      </div>
    </div>
    
    <!-- EDITOR VIEW -->
    <div id="editorView" style="display:none;">
      <div class="editor-controls">
          <button id="backBtn">&larr; Back to Dashboard</button>
          <div class="right-controls">
              <button id="downloadZipBtn" class="primary">Download ZIP</button>
              <button id="downloadEpubBtn">Download EPUB</button>
          </div>
      </div>
      <div class="editor-grid">
        <div id="chapterListContainer" class="chapter-list-container">
            <div class="list-header">Chapters <span class="small muted">(drag to reorder)</span></div>
            <ul id="chapterList">
                <!-- Chapters will be rendered here -->
            </ul>
        </div>
        <div id="chapterEditorContainer" class="chapter-editor-container">
            <div class="editor-toolbar">
                <button id="saveChapterBtn" disabled>Save Changes</button>
                <button id="splitChapterBtn" disabled>Split at Cursor</button>
                <button id="fullscreenBtn">Fullscreen</button>
            </div>
            <div class="find-replace-widget">
                <input type="text" id="findInput" placeholder="Find...">
                <input type="text" id="replaceInput" placeholder="Replace with...">
                <button id="replaceAllBtn">Replace All</button>
            </div>
            <textarea id="chapterContent" placeholder="Select a chapter to view its content..."></textarea>
        </div>
      </div>
    </div>

    <div id="progressContainer" class="progress">
      <div id="progressBar" class="bar" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
      <div id="progressText" class="txt" aria-live="polite">0%</div>
    </div>
    <div id="spinnerNovelSplitter" class="w-10 h-10 border-4 border-slate-200 dark:border-slate-700 rounded-full border-t-primary-600 animate-spin my-4 mx-auto hidden" role="status" aria-live="polite" aria-label="Loading"></div>
    <div class="small muted" style="margin-top:8px">Note: filenames inside ZIP/EPUB are zero-padded (000_, 001_, â€¦) so they sort correctly.</div>
  </div>

  <div id="tooltip" style="display:none;" role="tooltip"></div>
</div>