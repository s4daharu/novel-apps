<!-- Enhanced Find & Replace in Backup File -->
<div id="findReplaceBackupApp" class="tool-section max-w-full h-[calc(100vh-56px-env(safe-area-inset-top))] md:h-[calc(100vh-72px-env(safe-area-inset-top))] flex flex-col bg-slate-200 dark:bg-slate-900/80 hidden relative">
  <!-- Initial Upload View -->
  <div id="frUploadArea" class="absolute inset-0 bg-white/80 dark:bg-slate-900/50 z-20 flex flex-col items-center justify-center p-4 transition-opacity duration-300 ease-in-out">
    <h1 class="text-2xl md:text-3xl font-bold text-gray-900 dark:text-white mb-5 text-center">Find & Replace in Backup</h1>
    <div class="max-w-md mx-auto">
      <label for="frBackupFile" class="inline-flex items-center justify-center px-4 py-2 rounded-lg font-medium bg-violet-600 hover:bg-violet-700 text-white shadow-lg hover:shadow-xl transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-violet-500 focus:ring-offset-2 dark:focus:ring-offset-slate-800 focus:ring-offset-slate-100 w-full cursor-pointer" id="frBackupFileLabel">Upload Backup File</label>
      <input type="file" id="frBackupFile" accept=".json,.txt,.nov" class="hidden" aria-labelledby="frBackupFileLabel">
      <p class="text-xs text-slate-500 dark:text-slate-400 mt-2 text-center">Upload a .json, .txt, or .nov backup file to begin.</p>
    </div>
  </div>

  <!-- Header -->
  <div id="frHeader" class="flex-shrink-0 flex items-center justify-between p-2 bg-white dark:bg-slate-800 border-b border-slate-200 dark:border-slate-700 hidden">
    <h2 id="frFileName" class="text-sm font-medium text-slate-700 dark:text-slate-300 truncate px-2"></h2>
    <div class="flex items-center gap-2">
        <button id="frCloseToolBtn" class="inline-flex items-center justify-center px-3 py-1.5 text-sm rounded-lg font-medium bg-slate-200 hover:bg-slate-300 text-slate-800 dark:bg-slate-600 dark:hover:bg-slate-500 dark:text-white shadow-md transition-all">Close</button>
    </div>
  </div>

  <!-- Scrollable container for main content and controls -->
  <div class="flex-grow overflow-y-auto">
    <!-- Main Content Area -->
    <div id="frMainContent" class="w-full bg-slate-50 dark:bg-slate-800 hidden p-4 md:p-8 flex justify-center">
      <div class="w-full max-w-2xl">
          <div id="frSingleResultPreview" class="p-4 bg-white dark:bg-slate-800/50 rounded-lg border border-slate-200 dark:border-slate-700 text-sm hidden min-h-[8rem]">
              <!-- Single result preview will be populated here by JS -->
          </div>
          <div id="frHelperText" class="text-center p-8 text-slate-500 dark:text-slate-400">
              <p>Enter a search term to find results in your backup file.</p>
          </div>
      </div>
    </div>

    <!-- Controls Panel (now inside scrollable area) -->
    <div id="frHud" class="bg-slate-50/80 dark:bg-slate-800/80 backdrop-blur-md border-t border-slate-300 dark:border-slate-700 p-3 pb-[calc(0.75rem+env(safe-area-inset-bottom))] hidden">
      <div class="relative max-w-4xl mx-auto">
          <!-- Main controls -->
          <div class="space-y-3">
              <!-- Find Row -->
              <div class="flex items-center gap-2">
                  <div class="relative flex-grow">
                       <input type="text" id="findPattern" placeholder="Find" class="w-full bg-slate-100 dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-md px-3 py-2 pr-24 text-base text-slate-800 dark:text-slate-200 focus:border-primary-500 focus:ring-1 focus:ring-primary-500">
                       <div id="frMatchCountDisplay" class="absolute right-3 top-1/2 -translate-y-1/2 text-sm text-slate-500 dark:text-slate-400 bg-slate-100 dark:bg-slate-700 px-1 pointer-events-none">No results</div>
                  </div>
                  <button id="findPreviousBtn" class="bg-white dark:bg-slate-700 border border-slate-300 dark:border-slate-600 text-slate-800 dark:text-slate-200 w-10 h-10 rounded-md inline-flex items-center justify-center text-2xl transition-all hover:bg-primary-600 hover:text-white hover:border-primary-600 disabled:opacity-50 disabled:cursor-not-allowed" aria-label="Find Previous">‹</button>
                  <button id="findNextBtn" class="bg-white dark:bg-slate-700 border border-slate-300 dark:border-slate-600 text-slate-800 dark:text-slate-200 w-10 h-10 rounded-md inline-flex items-center justify-center text-2xl transition-all hover:bg-primary-600 hover:text-white hover:border-primary-600 disabled:opacity-50 disabled:cursor-not-allowed" aria-label="Find Next">›</button>
              </div>
              <!-- Replace Row -->
              <div class="flex items-center gap-2">
                  <input type="text" id="replaceText" placeholder="Replace with" class="flex-grow bg-slate-100 dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-md px-3 py-2 text-base text-slate-800 dark:text-slate-200 focus:border-primary-500 focus:ring-1 focus:ring-primary-500">
                  <button id="replaceNextBtn" class="flex-grow bg-white dark:bg-slate-700 border border-slate-300 dark:border-slate-600 text-slate-800 dark:text-slate-200 h-10 rounded-md inline-flex items-center justify-center text-sm font-medium transition-all hover:bg-primary-600 hover:text-white hover:border-primary-600 disabled:opacity-50 disabled:cursor-not-allowed">Replace</button>
                  <button id="replaceAllBtn" class="flex-grow bg-white dark:bg-slate-700 border border-slate-300 dark:border-slate-600 text-slate-800 dark:text-slate-200 h-10 rounded-md inline-flex items-center justify-center text-sm font-medium transition-all hover:bg-primary-600 hover:text-white hover:border-primary-600 disabled:opacity-50 disabled:cursor-not-allowed">Replace All</button>
              </div>
               <!-- Search Options -->
               <div class="flex items-center justify-center gap-4 flex-wrap">
                  <div class="flex justify-center bg-slate-100 dark:bg-slate-700 rounded-md p-1">
                      <label class="flex-1 flex justify-center px-3 py-1.5 transition-colors duration-200 rounded-md has-[:checked]:bg-primary-500/20" for="useRegexBackup" title="Use Regular Expression">
                          <input type="checkbox" id="useRegexBackup" class="hidden">
                          <span class="text-sm font-mono text-slate-600 dark:text-slate-300 has-[:checked]:text-primary-600">Regex</span>
                      </label>
                      <label class="flex-1 flex justify-center px-3 py-1.5 transition-colors duration-200 rounded-md has-[:checked]:bg-primary-500/20" for="frCaseSensitiveCheckbox" title="Case Sensitive">
                          <input type="checkbox" id="frCaseSensitiveCheckbox" class="hidden">
                          <span class="text-sm font-medium text-slate-600 dark:text-slate-300 has-[:checked]:text-primary-600 whitespace-nowrap">Case-sensitive</span>
                      </label>
                      <label class="flex-1 flex justify-center px-3 py-1.5 transition-colors duration-200 rounded-md has-[:checked]:bg-primary-500/20" for="frWholeWordCheckbox" title="Match Whole Word">
                          <input type="checkbox" id="frWholeWordCheckbox" class="hidden">
                          <span class="text-sm font-medium text-slate-600 dark:text-slate-300 has-[:checked]:text-primary-600 whitespace-nowrap">Whole word</span>
                      </label>
                  </div>
                  <button id="downloadCurrentFrBackupBtn" class="inline-flex items-center justify-center px-3 py-1.5 text-sm rounded-lg font-medium bg-primary-600 hover:bg-primary-700 text-white shadow-md transition-all disabled:opacity-60 disabled:cursor-not-allowed" disabled>Download</button>
              </div>
          </div>
      </div>
    </div>
  </div>

  <!-- Review All Modal -->
  <div id="frReviewModal" class="absolute inset-0 bg-slate-100/70 dark:bg-black/70 backdrop-blur-sm z-40 flex items-center justify-center p-4 hidden">
    <div class="bg-white dark:bg-slate-800 rounded-xl border border-slate-300 dark:border-slate-700 w-full max-w-2xl max-h-[90vh] flex flex-col overflow-hidden">
      <div class="p-4 border-b border-slate-200 dark:border-slate-700 flex justify-between items-center flex-shrink-0">
        <h2 id="frReviewHeaderTitle" class="text-xl font-semibold text-slate-900 dark:text-white">Review Changes</h2>
        <button id="frCloseReviewModalBtn" class="text-2xl bg-none border-none text-slate-500 hover:text-slate-800 dark:text-slate-400 dark:hover:text-white cursor-pointer" aria-label="Close review modal">&times;</button>
      </div>
      <div class="p-3 bg-slate-100 dark:bg-slate-900/50 flex-shrink-0">
        <label class="flex items-center gap-2 justify-start text-slate-800 dark:text-slate-200 select-none cursor-pointer">
          <input type="checkbox" id="frReviewSelectAll" class="w-4 h-4 align-middle rounded border-slate-400 dark:border-slate-500 focus:ring-2 focus:ring-primary-500 accent-primary-600" checked>
          <span id="frReviewSummaryText">X replacements proposed</span>
        </label>
      </div>
      <ul id="frReviewList" class="list-none p-0 m-0 overflow-y-auto flex-grow">
        <!-- Review items injected by JS -->
      </ul>
      <div class="p-4 border-t border-slate-200 dark:border-slate-700 flex justify-end gap-4 flex-shrink-0">
        <button id="frCancelReviewBtn" class="inline-flex items-center justify-center px-4 py-2 rounded-lg font-medium bg-slate-200 hover:bg-slate-300 text-slate-800 dark:bg-slate-600 dark:hover:bg-slate-500 dark:text-white shadow-lg hover:shadow-xl transition-all">Cancel</button>
        <button id="frConfirmReplaceAllBtn" class="inline-flex items-center justify-center px-4 py-2 rounded-lg font-medium bg-primary-600 hover:bg-primary-700 text-white shadow-lg hover:shadow-xl transition-all">Confirm Replacements</button>
      </div>
    </div>
  </div>

  <!-- Global Spinner -->
  <div id="spinnerFindReplaceBackup" class="w-10 h-10 border-4 border-slate-200 dark:border-slate-700 rounded-full border-t-primary-600 animate-spin absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 z-50 hidden"></div>
</div>
